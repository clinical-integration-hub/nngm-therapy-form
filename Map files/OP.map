/*
To Do:
- //OperativeIntention -> conceptmap?

- //ArtDesEingriffs ->  allow multiple values? check if thats the case

- //ArtDerResektion -> allow multiple values? check if thats the case

- //Ektomie -> cc()    ConceptMap ops subset? 

- //Todesdatum How to link patient to procedure and read patient.deceasedDate? add patient as source, add patient to transformbundle? add patient operation? what does posthandler do?

*/

/// version = 0.1
/// title = "nNGM: Mapping Therapieform"
/// status = draft

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_TherapieOP" = nNGM_Mapping_TherapieformOP

uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as source
uses "http://hl7.org/fhir/StructureDefinition/Procedure" as target

group TransformBundle(source src: CTS_Transport, target bundle: Bundle) {
    src -> bundle.id = uuid();
    src -> bundle.type = 'collection';


    src -> bundle.entry as entry,
        entry.resource = create('Procedure') as procedure
    then TransformProcedureOperation(src, procedure);
}

group TransformProcedureOperation(source src: CTS_Transport, target tgt: Procedure) {
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Procedure/nNGM/OP';

    src.operations as operations, operations.data as data then {
        //Operationsdatum
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_842'"
        then {
            values.value as operationsdatum -> tgt.performedDateTime = dateOp(operationsdatum);
        };

        //DurchfÃ¼hrendeEinrichtung
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_1162'"
        then {
            values.value as durchfuehrendeEinrichtung -> tgt.performer = create('BackboneElement') as performer,
                performer.actor as actor,
                actor.display = durchfuehrendeEinrichtung;
        };


        //OperativeIntention -> conceptmap?
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_1167'"
        then {
            values.value as operationsmerkmale -> tgt.extension as intentionop,
                intentionop.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/intention-op',
                intentionop.value = operationsmerkmale;
        };

        //ArtDesEingriffs ->  allow multiple values?
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_1168'"
        then {
            values.value as artdeseingrifs -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/OpsUnk', artdeseingrifs);
        };


        //Lokalisation allow only 1 value, build in logic to accept text  
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2335'"
        then {
            values.value as value -> tgt.bodySite = create('BackboneElement') as bodysite,
                bodysite.coding = c('http://uk-koeln.de/fhir/ValueSet/cancer-base/icdo-o-3-t', value);
            //bodysite.text = values[2].value; 
        };

        //Seitenlokalisation --> cc     
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2400'"
        then {
            values.value as value -> tgt.bodySite = create('BackboneElement') as bodysite collate,
                bodysite.coding = c('https://www.uk-koeln.de/fhir/ValueSet/Seitenlokalisation_Typ', value);
        };

        //ArtDerResektion -> select multiple?, need conceptmap?
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_1176'"
        then {
            values.value as artderresektion -> tgt.category = cc('https://www.uk-koeln.de/fhir/ValueSet/OpCategory', artderresektion);
        };

        //ResektionStatus -> conceptmap?     
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_1353'"
        then {
            values.value as resektionStatus -> tgt.outcome = cc('http://uk-koeln.de/fhir/ValueSet/cancer-base/residualtumor', resektionStatus);
        };

        //Ektomie -> cc()    ConceptMap ops subset?
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_1362'"
        then {
            values.value as ektomie -> tgt.code = cc('https://www.uk-koeln.de/fhir/ValueSet/OpsUnk', ektomie);
        };

        /*
        //TodesDatum ref to patient.deceasedDate
        data.values as values where "blockindex = 1 and groupindex = 24 and itemid = 'id_2239'" then
        {
            values.value as todesdatum -> create('Reference') as patient,
            patient.deceasedDate = dateOp('todesdatum');
        }; 
        */

        //Sontstiges --> string;     
        data.values as values where "blockindex = 3 and groupindex = 0 and itemid = 'id_1472'"
        then {
            values.value as sonstiges -> tgt.note = create('BackboneElement') as note,
                note.text = sonstiges;
        };
    };
}